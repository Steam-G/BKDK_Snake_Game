<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        canvas {
            border: 1px solid #000;
            background-color: #fff;
        }
        #score {
            margin: 10px;
            font-size: 20px;
            font-family: Arial, sans-serif;
        }
        #game-over, #restart-button {
            display: none;
            font-size: 40px;
            font-family: Arial, sans-serif;
            color: red;
            margin-top: 20px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }
        .controls div {
            display: flex;
            justify-content: center;
        }
        .control-button, #restart-button {
            width: 50px;
            height: 50px;
            margin: 5px;
            font-size: 20px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="380" height="380"></canvas>
    <div id="score">Счет: 0</div>
    <div id="game-over">Вы проиграли!</div>
    <button id="restart-button" onclick="restartGame()">Перезапуск</button>
    <div class="controls">
        <div>
            <button class="control-button" onclick="setDirection('UP')">↑</button>
        </div>
        <div>
            <button class="control-button" onclick="setDirection('LEFT')">←</button>
            <button class="control-button" onclick="setDirection('DOWN')">↓</button>
            <button class="control-button" onclick="setDirection('RIGHT')">→</button>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const gameOverDisplay = document.getElementById('game-over');
        const restartButton = document.getElementById('restart-button');

        const snakeHeadImg = new Image();
        const snakeBodyImg = new Image();
        const fruitImg = new Image();
        const treeImg = new Image();
        const explosionImgs = [new Image(), new Image(), new Image()];

        snakeHeadImg.src = 'snake_head.png';
        snakeBodyImg.src = 'snake_body.png';
        fruitImg.src = 'fruit.png';
        treeImg.src = 'tree.png';
        explosionImgs[0].src = 'explosion1.png';
        explosionImgs[1].src = 'explosion2.png';
        explosionImgs[2].src = 'explosion3.png';

        const box = 20;
        let snake, oldSnake, fruit, tree, d, score, speed, gameInterval, treeTimer;

        function initializeGame() {
            snake = [{ x: 9 * box, y: 10 * box }];
            oldSnake = [];
            fruit = {
                x: Math.floor(Math.random() * 18 + 1) * box,
                y: Math.floor(Math.random() * 18 + 1) * box
            };
            tree = null;
            d = null;
            score = 0;
            speed = 200;
            scoreDisplay.innerText = "Счет: " + score;
            gameOverDisplay.style.display = "none";
            restartButton.style.display = "none";
            clearInterval(gameInterval);
            clearTimeout(treeTimer);
            gameInterval = setInterval(draw, speed);
            setTimeout(() => {
                placeTree();
                treeTimer = setInterval(() => {
                    placeTree();
                }, 10000);
            }, 10000);
        }

        document.addEventListener("keydown", direction);

        function direction(event) {
            if (event.keyCode == 37 && d != "RIGHT") {
                d = "LEFT";
            } else if (event.keyCode == 38 && d != "DOWN") {
                d = "UP";
            } else if (event.keyCode == 39 && d != "LEFT") {
                d = "RIGHT";
            } else if (event.keyCode == 40 && d != "UP") {
                d = "DOWN";
            }
        }

        function setDirection(newDirection) {
            if (newDirection == "LEFT" && d != "RIGHT") {
                d = "LEFT";
            } else if (newDirection == "UP" && d != "DOWN") {
                d = "UP";
            } else if (newDirection == "RIGHT" && d != "LEFT") {
                d = "RIGHT";
            } else if (newDirection == "DOWN" && d != "UP") {
                d = "DOWN";
            }
        }

        function collision(head, array) {
            for (let i = 0; i < array.length; i++) {
                if (head.x == array[i].x && head.y == array[i].y) {
                    return true;
                }
            }
            return false;
        }

        function placeTree() {
            let validPosition = false;
            while (!validPosition) {
                let treeX = Math.floor(Math.random() * 15 + 1) * box;
                let treeY = Math.floor(Math.random() * 14 + 1) * box;
                validPosition = true;

                if (Math.abs(treeX - fruit.x) < 3 * box && Math.abs(treeY - fruit.y) < 3 * box) {
                    validPosition = false;
                }

                for (let i = 0; i < snake.length; i++) {
                    if (Math.abs(treeX - snake[i].x) < 3 * box && Math.abs(treeY - snake[i].y) < 3 * box) {
                        validPosition = false;
                        break;
                    }
                }

                if (validPosition) {
                    tree = { x: treeX, y: treeY };
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < snake.length; i++) {
                if (i == 0) {
                    ctx.drawImage(snakeHeadImg, snake[i].x, snake[i].y, box, box);
                } else {
                    ctx.drawImage(snakeBodyImg, snake[i].x, snake[i].y, box, box);
                }
            }

            ctx.drawImage(fruitImg, fruit.x, fruit.y, box, box);

            if (tree) {
                ctx.drawImage(treeImg, tree.x, tree.y, box * 4, box * 5);
            }

            let snakeX = snake[0].x;
            let snakeY = snake[0].y;

            if (d == "LEFT") snakeX -= box;
            if (d == "UP") snakeY -= box;
            if (d == "RIGHT") snakeX += box;
            if (d == "DOWN") snakeY += box;

            if (snakeX == fruit.x && snakeY == fruit.y) {
                fruit = {
                    x: Math.floor(Math.random() * 18 + 1) * box,
                    y: Math.floor(Math.random() * 18 + 1) * box
                };
                score++;
                scoreDisplay.innerText = "Счет: " + score;
                clearInterval(gameInterval);
                speed -= 3;
                gameInterval = setInterval(draw, speed);
                placeTree();
            } else {
                oldSnake = [...snake]; // Сохраняем предыдущее состояние змейки
                snake.pop();
            }

            let newHead = { x: snakeX, y: snakeY };

            if (snakeX < 0 || snakeX >= 20 * box || snakeY < 0 || snakeY >= 20 * box || collision(newHead, snake) || (tree && snakeX >= tree.x && snakeX < tree.x + 4 * box && snakeY >= tree.y && snakeY < tree.y + 6 * box)) {
                clearInterval(gameInterval);
                clearInterval(treeTimer);
                triggerExplosion([...oldSnake]); // Используем oldSnake для анимации взрывов
                gameOverDisplay.style.display = "block";
                restartButton.style.display = "block";
                return;
            }

            snake.unshift(newHead);
        }

        function triggerExplosion(snake) {
            let segmentIndex = 0;

            function animateExplosion() {
                if (segmentIndex >= snake.length) {
                    return;
                }

                for (let i = 0; i < explosionImgs.length; i++) {
                    setTimeout(() => {
                        ctx.clearRect(snake[segmentIndex].x, snake[segmentIndex].y, box, box);
                        ctx.drawImage(explosionImgs[i], snake[segmentIndex].x, snake[segmentIndex].y, box, box);
                    }, i * 100);
                }

                segmentIndex++;
                if (segmentIndex < snake.length) {
                    setTimeout(animateExplosion, explosionImgs.length * 100);
                }
            }

            animateExplosion();
        }

        function restartGame() {
            initializeGame();
        }

        initializeGame();
    </script>
</body>
</html>
